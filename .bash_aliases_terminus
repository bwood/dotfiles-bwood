##############
## Terminus ##
##############

_terminus-hostname() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "terminus-hostname Must pass a site shortname as the first argument, for example: site-name"
    exit 1
  fi

  ENV=$2
  if [ x$ENV = x ]; then
    echo "terminus-hostname: Must pass an environment as the second argument."
    exit 1
  fi

  TYPE=$3
  if [ x$TYPE = x ]; then
    echo "terminus-hostname: Must pass server type as the third argument."
    exit 1
  fi

  ID=$(terminus site info --field=id --site=$SITE)
  HOSTNAME=""
  if [ -n "$ID" ]; then 
    HOSTNAME="$ENV.$ID@$TYPE.$ENV.$ID.drush.in"
  else 
    echo ""
    echo "Site '$SITE' not found."
  fi
}

terminus-sftp() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "
USAGE:

terminus-sftp site-shortname

Make an sftp connection to a site.

  site-shortname: REQUIRED: If your site is dev-example.pantheon.io
                  this would be "example" 

"
    return
  fi

  _terminus-hostname "$SITE" "dev" "appserver"

  if [ -n "$HOSTNAME" ]; then
    CMD="sftp -o Port=2222 $HOSTNAME"
    echo $CMD
    $CMD
  fi
}

alias tsftp=terminus-sftp

terminus-logs() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "
USAGE:

terminus-logs site-shortname

Gets the logs for the site 

  site-shortname: REQUIRED: If your site is dev-example.pantheon.io
                  this would be "example" 

"
    return
  fi

  DIR="/tmp"


  SFTP_CMDS="cd logs
  lcd $DIR/$SITE
  mget php*
  get nginx-access.log"

  _terminus-hostname "$SITE" "dev" "appserver"

  if [ -n "$HOSTNAME" ]; then
    # if the log directory exists delete it
    if [ ! -d "$DIR/$SITE" ]; then
      mkdir "$DIR/$SITE"
    fi

    echo ""
    echo "Connecting to $SITE..."
    CMD="sftp -o Port=2222 $HOSTNAME"
    echo "$SFTP_CMDS" | $CMD

    echo ""
    echo "Logs downloaded to $DIR/$SITE."
    echo ""
    cd "$DIR/$SITE"
    ls -l
  fi
}

alias tlogs=terminus-logs

terminus-git-clone() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "Must pass a site shortname as the first argument, for example: site-name"
    return
  fi

  SITES_DIR=~/Sites/pantheon  
  cd $SITES_DIR
  if [ -d "$SITE" ]; then
    echo "You already cloned $SITE. Doing a git pull..." 
    cd $SITE
    git pull
    return
  fi

  TYPE="codeserver"
  _terminus-hostname $SITE "dev" $TYPE

  if [ -n "$HOSTNAME" ]; then
    CMD="git clone ssh://$TYPE.$HOSTNAME:2222/~/repository.git $SITE --depth=1"
    $CMD
    cd $SITE
  fi
}

alias tgc=terminus-git-clone


terminus-dashboard() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "Must pass a site shortname as the first argument, for example: site-name"
    return
  fi
  terminus site dashboard --yes --site=$SITE 
}

alias tdash=terminus-dashboard

terminus-site-wake() {
  SITE=$1
  if [ x$SITE = x ]; then
    echo "Must pass a site shortname as the first argument, for example: site-name"
    return
  fi
  terminus site wake --site=$SITE --env=dev
  terminus site wake --site=$SITE --env=test
}

alias tsite-wake=terminus-site-wake
alias tsw=terminus-site-wake

alias tal="terminus auth login $EMAIL_WORK"
#source /Users/bwood/bin/terminus-completion.bash

terminus-cache-clear () {
  terminus cli cache-clear
  terminus auth login $EMAIL_WORK
  terminus sites list |head -3 # warm the terminus cache
}

alias tcc=terminus-cache-clear
